---
title: Generated Scripts
description: Understanding the output of ha-syncgen and what each file does
---

import { Callout } from 'fumadocs-ui/components/callout';
import { Tabs, Tab } from 'fumadocs-ui/components/tabs';

# Generated Scripts

Learn about the scripts and configuration files that ha-syncgen creates for your PostgreSQL HA cluster.

## Output Structure

When you run `ha-syncgen build cluster.yaml`, the following directory structure is created:

```
generated/
├── primary/
│   ├── setup_primary.sh           # Primary server setup script
│   ├── postgresql.conf.patch      # PostgreSQL configuration
│   └── pg_hba.conf.patch         # Authentication configuration
└── replica-{host}/               # One directory per replica
    ├── setup_replication.sh      # Replica setup script
    ├── health_check.sh           # Health monitoring script
    ├── ha-postgres-health.service # Systemd service file
    └── ha-postgres-health.timer   # Systemd timer file
```

<Callout type="info">
  Each replica gets its own directory named `replica-{host}` where `{host}` is the replica's IP address or hostname.
</Callout>

## Primary Server Files

### setup_primary.sh

The primary setup script configures the PostgreSQL primary server for streaming replication.

**What it does:**
- Creates the replication user with proper permissions
- Creates physical replication slots for each replica
- Grants necessary database permissions
- Verifies replication slot creation

**Example script content:**
```bash
#!/bin/bash
# Replication slot setup script for PostgreSQL primary
# Generated by ha-syncgen

set -e

echo "Setting up replication slots on primary PostgreSQL server..."

# Connect to PostgreSQL and create replication slots
psql -h 127.0.0.1 -p 5432 -U postgres -d postgres << 'EOF'
-- Create replication user if it doesn't exist
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = 'replicator') THEN
        CREATE ROLE replicator WITH REPLICATION LOGIN PASSWORD 'your_password';
        GRANT CONNECT ON DATABASE postgres TO replicator;
    END IF;
END
$$;

-- Create replication slot for replica 1
SELECT CASE 
    WHEN NOT EXISTS (SELECT 1 FROM pg_replication_slots WHERE slot_name = 'replica_slot_1') 
    THEN pg_create_physical_replication_slot('replica_slot_1')
    ELSE NULL
END;

-- Create replication slot for replica 2
SELECT CASE 
    WHEN NOT EXISTS (SELECT 1 FROM pg_replication_slots WHERE slot_name = 'replica_slot_2') 
    THEN pg_create_physical_replication_slot('replica_slot_2')
    ELSE NULL
END;
EOF

echo "Replication slots setup completed!"
```

**To execute:**
```bash
# Copy to primary server
scp generated/primary/setup_primary.sh user@primary-server:/tmp/

# Execute on primary server
ssh user@primary-server "sudo chmod +x /tmp/setup_primary.sh && sudo -u postgres /tmp/setup_primary.sh"
```

### postgresql.conf.patch

Configuration patch for the primary PostgreSQL server to enable streaming replication.

**Key settings:**
- **wal_level**: Set to `replica` for streaming replication
- **max_wal_senders**: Number of concurrent replication connections
- **wal_keep_size**: WAL retention for replica recovery
- **hot_standby**: Enables read queries on replicas
- **replication slots**: Configuration for reliable replication

**Example content:**
```ini
# PostgreSQL Streaming Replication Configuration
# Generated by ha-syncgen
# Add these settings to your postgresql.conf

# WAL (Write-Ahead Logging) settings for replication
wal_level = replica
max_wal_senders = 3
wal_keep_size = 1GB

# Archive settings (optional but recommended)
archive_mode = on
archive_command = 'test ! -f /var/lib/postgresql/archive/%f && cp %p /var/lib/postgresql/archive/%f'

# Hot standby settings
hot_standby = true

# Synchronous replication settings
synchronous_commit = on

# Enable replication slots (recommended)
max_replication_slots = 4

# Connection settings
listen_addresses = '*'
port = 5432

# Logging for replication monitoring
log_replication_commands = on
log_min_messages = info
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '

# Performance tuning for replication
max_connections = 100
shared_buffers = 256MB
effective_cache_size = 1GB
```

**To apply:**
```bash
# Backup original configuration
sudo cp /etc/postgresql/14/main/postgresql.conf /etc/postgresql/14/main/postgresql.conf.backup

# Apply patch
sudo cat generated/primary/postgresql.conf.patch >> /etc/postgresql/14/main/postgresql.conf

# Restart PostgreSQL
sudo systemctl restart postgresql
```

### pg_hba.conf.patch

Authentication configuration to allow replication connections from replica servers.

**What it configures:**
- Replication connections from each replica IP
- Authentication method (MD5 by default)
- Local and remote replication access
- Health check database connections

**Example content:**
```ini
# pg_hba.conf entries for PostgreSQL streaming replication
# Generated by ha-syncgen
# Add these lines to your pg_hba.conf file

# Replication connections from replica servers
host    replication    replicator    10.0.1.11/32    md5
host    replication    replicator    10.0.1.12/32    md5

# Allow local replication connections (for monitoring)
local   replication    replicator                     md5
host    replication    replicator    127.0.0.1/32    md5
host    replication    replicator    ::1/128         md5

# Database connections for health checks
host    postgres       replicator    10.0.1.11/32    md5
host    postgres       replicator    10.0.1.12/32    md5
```

**To apply:**
```bash
# Backup original configuration
sudo cp /etc/postgresql/14/main/pg_hba.conf /etc/postgresql/14/main/pg_hba.conf.backup

# Apply patch
sudo cat generated/primary/pg_hba.conf.patch >> /etc/postgresql/14/main/pg_hba.conf

# Reload PostgreSQL configuration
sudo systemctl reload postgresql
```

## Replica Server Files

### setup_replication.sh

Configures a replica server to stream from the primary using pg_basebackup.

**What it does:**
- Stops PostgreSQL service
- Backs up existing data directory
- Performs pg_basebackup from primary
- Creates standby.signal file
- Configures recovery settings
- Starts PostgreSQL in replica mode

**Example script content:**
```bash
#!/bin/bash
# Streaming replication setup script for replica 10.0.1.11
# Generated by ha-syncgen

set -e

LOG_FILE="/var/log/ha-syncgen/setup-10.0.1.11.log"
PRIMARY_HOST="10.0.1.10"
PRIMARY_PORT="5432"
REPLICATION_USER="replicator"
DATA_DIR="/var/lib/postgresql/data"
REPLICATION_SLOT="replica_slot_1"

# Ensure log directory exists
mkdir -p "$(dirname "$LOG_FILE")"

echo "Setting up streaming replication from $PRIMARY_HOST:$PRIMARY_PORT" | tee -a "$LOG_FILE"

# Stop PostgreSQL if running
systemctl stop postgresql || true

# Backup existing data directory
if [ -d "$DATA_DIR" ]; then
    mv "$DATA_DIR" "${DATA_DIR}.backup.$(date +%Y%m%d_%H%M%S)"
fi

# Perform base backup from primary
echo "Performing pg_basebackup from primary..." | tee -a "$LOG_FILE"
sudo -u postgres pg_basebackup \
    -h "$PRIMARY_HOST" \
    -p "$PRIMARY_PORT" \
    -U "$REPLICATION_USER" \
    -D "$DATA_DIR" \
    -S "$REPLICATION_SLOT" \
    -v -P -R

# Create standby signal
sudo -u postgres touch "$DATA_DIR/standby.signal"

# Set proper permissions
chown -R postgres:postgres "$DATA_DIR"

# Start PostgreSQL
systemctl start postgresql
systemctl enable postgresql

echo "Replication setup completed successfully!" | tee -a "$LOG_FILE"
```

**To execute:**
```bash
# Copy to replica server
scp generated/replica-10.0.1.11/setup_replication.sh user@replica-server:/tmp/

# Execute on replica server (requires sudo)
ssh user@replica-server "sudo chmod +x /tmp/setup_replication.sh && sudo /tmp/setup_replication.sh"
```

### health_check.sh

Monitors the primary server and triggers failover if the primary becomes unavailable.

**What it does:**
- Tests network connectivity to primary
- Checks PostgreSQL availability
- Monitors replication lag
- Promotes replica if primary fails (when enabled)
- Logs all health check results

**Example script content:**
```bash
#!/bin/bash
# Health check script for PostgreSQL primary at 10.0.1.10
# Monitoring from replica 10.0.1.11
# Generated by ha-syncgen

set -e

LOG_FILE="/var/log/ha-syncgen/health-check-10.0.1.11.log"
PRIMARY_HOST="10.0.1.10"
PRIMARY_PORT="5432"
REPLICA_HOST="10.0.1.11"
REPLICATION_USER="replicator"
DATA_DIR="/var/lib/postgresql/data"

# Ensure log directory exists
mkdir -p "$(dirname "$LOG_FILE")"

echo "$(date): Starting health check for primary $PRIMARY_HOST:$PRIMARY_PORT" >> "$LOG_FILE"

# Check network connectivity
if ! nc -z "$PRIMARY_HOST" "$PRIMARY_PORT"; then
    echo "$(date): ERROR - Cannot connect to primary $PRIMARY_HOST:$PRIMARY_PORT" >> "$LOG_FILE"
    
    # Auto-promote if enabled and we're a replica
    if [ -f "$DATA_DIR/standby.signal" ]; then
        echo "$(date): Promoting replica to primary..." >> "$LOG_FILE"
        sudo -u postgres pg_promote -D "$DATA_DIR"
        rm -f "$DATA_DIR/standby.signal"
        echo "$(date): Promotion completed" >> "$LOG_FILE"
    fi
    
    exit 1
fi

# Check PostgreSQL availability
if ! sudo -u postgres timeout 10 psql -h "$PRIMARY_HOST" -p "$PRIMARY_PORT" -U "$REPLICATION_USER" -d postgres -c "SELECT 1;" >/dev/null 2>&1; then
    echo "$(date): ERROR - PostgreSQL not responding on primary" >> "$LOG_FILE"
    exit 1
fi

echo "$(date): Health check passed - Primary is healthy" >> "$LOG_FILE"
exit 0
```

**Manual execution:**
```bash
# Test health check manually
sudo /path/to/health_check.sh

# Check logs
sudo tail -f /var/log/ha-syncgen/health-check-*.log
```

### Systemd Service Files

#### ha-postgres-health.service

Systemd service unit for running health checks.

**Example content:**
```ini
[Unit]
Description=PostgreSQL HA Health Check for replica 10.0.1.11
Documentation=https://github.com/HasithDeAlwis/ha-syncgen
After=postgresql.service network.target
Requires=postgresql.service
PartOf=postgresql.service

[Service]
Type=oneshot
User=postgres
Group=postgres
ExecStart=/path/to/health_check.sh
WorkingDirectory=/path/to/replica-directory
StandardOutput=journal
StandardError=journal
SyslogIdentifier=ha-syncgen-health-check

# Environment variables for the health check script
Environment=PGUSER=replicator
Environment=PGDATABASE=postgres
Environment=REPLICA_HOST=10.0.1.11
Environment=PRIMARY_HOST=10.0.1.10

# Security settings
NoNewPrivileges=true
PrivateTmp=true
ProtectSystem=strict
ProtectHome=true
ReadWritePaths=/var/log/ha-syncgen /var/lib/postgresql/data

# Restart behavior
RemainAfterExit=no
TimeoutStartSec=60
TimeoutStopSec=30

[Install]
WantedBy=multi-user.target
```

#### ha-postgres-health.timer

Systemd timer for scheduling regular health checks.

**Example content:**
```ini
[Unit]
Description=PostgreSQL HA Health Check Timer for replica 10.0.1.11
Documentation=https://github.com/HasithDeAlwis/ha-syncgen
Requires=ha-postgres-health.service
After=postgresql.service

[Timer]
# Run health check every 30 seconds
OnBootSec=2min
OnUnitActiveSec=30sec

# Ensure timer is persistent across reboots
Persistent=true

# Prevent timer drift
AccuracySec=5sec

# Randomize execution slightly to prevent thundering herd
RandomizedDelaySec=5sec

[Install]
WantedBy=timers.target
```

**To install systemd files:**
```bash
# Copy service files
sudo cp generated/replica-10.0.1.11/ha-postgres-health.service /etc/systemd/system/
sudo cp generated/replica-10.0.1.11/ha-postgres-health.timer /etc/systemd/system/

# Reload systemd and enable
sudo systemctl daemon-reload
sudo systemctl enable ha-postgres-health.timer
sudo systemctl start ha-postgres-health.timer

# Check status
sudo systemctl status ha-postgres-health.timer
sudo systemctl list-timers ha-postgres-health.timer
```

## Script Execution Order

Follow this order when deploying your PostgreSQL HA cluster:

1. **Primary Server Setup**
   ```bash
   # Apply configuration patches first
   sudo cat generated/primary/postgresql.conf.patch >> /etc/postgresql/14/main/postgresql.conf
   sudo cat generated/primary/pg_hba.conf.patch >> /etc/postgresql/14/main/pg_hba.conf
   sudo systemctl restart postgresql
   
   # Run primary setup script
   sudo -u postgres generated/primary/setup_primary.sh
   ```

2. **Replica Server Setup**
   ```bash
   # For each replica, run the setup script
   sudo generated/replica-{host}/setup_replication.sh
   ```

3. **Install Health Monitoring**
   ```bash
   # Install systemd files on each replica
   sudo cp generated/replica-{host}/*.service /etc/systemd/system/
   sudo cp generated/replica-{host}/*.timer /etc/systemd/system/
   sudo systemctl daemon-reload
   sudo systemctl enable ha-postgres-health.timer
   sudo systemctl start ha-postgres-health.timer
   ```
## Next Steps

- [Configuration Reference](/docs/configuration) - Learn all configuration options  
- [Troubleshooting](/docs/troubleshooting) - Common issues and solutions
- [Roadmap](/docs/roadmap) - See what features are planned
