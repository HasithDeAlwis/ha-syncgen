-- PostgreSQL Primary Database Initialization
-- Generated from config.yaml

CREATE USER {{ .DbUser }} WITH PASSWORD '{{ .DbPassword }}' SUPERUSER;

-- Create replication user for streaming replication
CREATE USER {{.ReplicationUser}} WITH PASSWORD '{{.ReplicationPassword}}' REPLICATION;

-- Configure replication settings
ALTER SYSTEM SET wal_level = '{{.WalLevel}}';
ALTER SYSTEM SET max_wal_senders = {{.MaxWalSenders}};
ALTER SYSTEM SET wal_keep_size = '{{.WalKeepSize}}';
ALTER SYSTEM SET hot_standby = {{.HotStandby}};
ALTER SYSTEM SET synchronous_commit = '{{.SynchronousCommit}}';

-- Reload configuration
SELECT pg_reload_conf();

-- Log successful initialization
DO $$
BEGIN
    RAISE NOTICE 'Primary PostgreSQL database initialized successfully';
    RAISE NOTICE 'Admin user: {{.DbUser}}';
    RAISE NOTICE 'Replication user: {{.ReplicationUser}}';
    RAISE NOTICE 'Monitoring user: datadog_user';
END $$;
