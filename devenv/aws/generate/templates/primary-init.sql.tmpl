-- PostgreSQL Primary Database Initialization
-- Generated from config.yaml

-- Create replication user for streaming replication
CREATE USER {{.ReplicationUser}} WITH PASSWORD '{{.ReplicationPassword}}' REPLICATION;

-- Create monitoring user for Datadog
CREATE USER datadog_user WITH PASSWORD '{{.DatadogPassword}}';

-- Grant necessary permissions to datadog user
GRANT SELECT ON pg_stat_database TO datadog_user;
GRANT SELECT ON pg_stat_replication TO datadog_user;
GRANT SELECT ON pg_stat_activity TO datadog_user;
GRANT SELECT ON pg_locks TO datadog_user;

-- Configure replication settings
ALTER SYSTEM SET wal_level = '{{.WalLevel}}';
ALTER SYSTEM SET max_wal_senders = {{.MaxWalSenders}};
ALTER SYSTEM SET wal_keep_size = '{{.WalKeepSize}}';
ALTER SYSTEM SET hot_standby = {{.HotStandby}};
ALTER SYSTEM SET synchronous_commit = '{{.SynchronousCommit}}';

-- Reload configuration
SELECT pg_reload_conf();

-- Log successful initialization
DO $$
BEGIN
    RAISE NOTICE 'Primary PostgreSQL database initialized successfully';
    RAISE NOTICE 'Admin user: {{.DbUser}}';
    RAISE NOTICE 'Replication user: {{.ReplicationUser}}';
    RAISE NOTICE 'Monitoring user: datadog_user';
END $$;
