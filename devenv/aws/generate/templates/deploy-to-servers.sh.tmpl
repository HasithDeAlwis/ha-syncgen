#!/bin/bash

# Complete SSH/SCP automation for PostgreSQL deployment
# Generated from config.yaml

set -e  # Exit on any error

SSH_KEY_PATH={{.SSHKeyPath}}
SSH_USER={{.SSHUser}}
GENERATED_DIR="./generated"
ROOT_GENERATED_DIR="../../generated"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Function to test SSH connectivity
test_ssh_connection() {
    local host=$1
    log_info "Testing SSH connection to $host..."
    
    if ssh -i $SSH_KEY_PATH -o ConnectTimeout=5 -o StrictHostKeyChecking=no $SSH_USER@$host "echo 'SSH OK'" > /dev/null 2>&1; then
        log_info "✅ SSH connection to $host successful"
        return 0
    else
        log_error "❌ SSH connection to $host failed"
        return 1
    fi
}

# Deploy SQL scripts to primary
PRIMARY_HOST={{.PrimaryIP}}
log_info "Deploying to primary: $PRIMARY_HOST"
test_ssh_connection $PRIMARY_HOST

log_info "Copying 01-setup-primary.sql to $PRIMARY_HOST:/home/ec2-user/"
scp -i $SSH_KEY_PATH $GENERATED_DIR/01-setup-primary.sql $SSH_USER@$PRIMARY_HOST:/home/ec2-user/
scp -i $SSH_KEY_PATH $ROOT_GENERATED_DIR/datadog/datadog.sql $SSH_USER@$PRIMARY_HOST:/home/ec2-user/

log_info "Running setup on $PRIMARY_HOST"
ssh -i $SSH_KEY_PATH $SSH_USER@$PRIMARY_HOST "sudo mv /home/ec2-user/01-setup-primary.sql /var/lib/pgsql/ && sudo -u postgres psql -d postgres -f /var/lib/pgsql/01-setup-primary.sql"
ssh -i $SSH_KEY_PATH $SSH_USER@$PRIMARY_HOST "sudo mv /home/ec2-user/datadog.sql /var/lib/pgsql/ && sudo -u postgres psql -d postgres -f /var/lib/pgsql/datadog.sql"

# Deploy SQL scripts to replicas
{{range $i, $replica := .Replicas}}
REPLICA_HOST={{$replica}}
REPLICA_SQL=01-setup-replica{{$i | add1}}.sql
log_info "Deploying to replica: $REPLICA_HOST"
test_ssh_connection $REPLICA_HOST

log_info "Copying $REPLICA_SQL to $REPLICA_HOST:/home/ec2-user/"
scp -i $SSH_KEY_PATH $GENERATED_DIR/$REPLICA_SQL $SSH_USER@$REPLICA_HOST:/home/ec2-user/
scp -i $SSH_KEY_PATH $ROOT_GENERATED_DIR/datadog/datadog.sql $SSH_USER@$REPLICA_HOST:/home/ec2-user/

log_info "Running setup on $REPLICA_HOST"
ssh -i $SSH_KEY_PATH $SSH_USER@$REPLICA_HOST "sudo mv /home/ec2-user/$REPLICA_SQL /var/lib/pgsql/ && sudo -u postgres psql -d postgres -f /var/lib/pgsql/$REPLICA_SQL"
ssh -i $SSH_KEY_PATH $SSH_USER@$REPLICA_HOST "sudo mv /home/ec2-user/datadog.sql /var/lib/pgsql/ && sudo -u postgres psql -d postgres -f /var/lib/pgsql/datadog.sql"
{{end}}

